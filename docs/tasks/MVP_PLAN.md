# Глобальный план работ: Этап MVP

## Обзор

**Цель MVP:** Реализовать минимальный функционал для приёма заказов на услуги массажа через Telegram-бот с управлением через Admin Panel.

**Компоненты системы:**
| Компонент | Технологии | Путь |
|-----------|------------|------|
| Backend (микросервисы) | Python, FastAPI, uvicorn | `C:\Users\zum\dev\python\NMservices` |
| Frontend (Telegram-бот) | Python, aiogram | `C:\Users\zum\dev\python\NMservices` |
| Frontend (Admin Panel) | TypeScript, React, react-admin, Vite | `C:\Users\zum\dev\js\NMservices-Admin` |
| База данных | PostgreSQL | nomus |

**Текущий статус:** Задачи 1, 1b, 2 завершены (2026-02-15)

---

## План работ

### Задача 1: Backend — Каталог услуг и расширение заказов ✅ ЗАВЕРШЕНА

**Описание:** Реализация функционала согласно `docs/tasks/MVP_services_table.md`

**Подзадачи:**
- [x] 1.1. Миграция: создание таблицы `services`
- [x] 1.2. Миграция: расширение таблицы `orders` (service_id, address_text, scheduled_at)
- [x] 1.3. SQLAlchemy модели (Service, обновление Order)
- [x] 1.4. Pydantic модели (ServiceResponse, ServiceCreateRequest, обновление OrderCreateRequest)
- [x] 1.5. API endpoints для услуг (CRUD)
- [x] 1.6. Обновление API endpoints для заказов
- [x] 1.7. Seed данные (базовые услуги)
- [x] 1.8. Обновление CLI утилиты (управление услугами)
- [x] 1.9. Тесты для новых endpoints (30/30 passed)
- [x] 1.10. Обновление документации

**Верификация (2026-02-10):**
- [x] Миграция БД на dm@id (3 миграции)
- [x] Структура БД через psql (7/7 проверок)
- [x] db_cli.py — услуги и заказы работают
- [x] pytest — 30/30 passed
- [x] API: GET /services, GET /services/1, POST /orders с service_id

**Критерии завершения:** см. `docs/tasks/MVP_services_table.md` → Критерии приёмки

---

### Задача 1b: Backend — Расширение API для Admin Panel ✅ ЗАВЕРШЕНА

**Описание:** Доработка backend API для полноценной поддержки Admin Panel (сортировка, фильтрация, поиск)

**Подзадачи:**
- [x] 1b.1. Перенос write-операций /services в /admin/services с X-Admin-Key авторизацией (PR #47)
- [x] 1b.2. Фильтрация по дате (date_from, date_to) для users, orders, services (PR #49)
- [x] 1b.3. Расширение сортировки (sort_by, order) для services: duration_minutes, created_at (PR #50)
- [x] 1b.4. Добавление sort_by полей для users и orders endpoints (PR #51)
- [x] 1b.5. Редактирование полей заказа: address_text, scheduled_at, service_id (PR #52)
- [x] 1b.6. Поиск пользователей по номеру телефона/ID (q параметр) (PR #53, #54)
- [x] 1b.7. Фильтрация заказов по user_id (PR #55)
- [x] 1b.8. Добавление created_at/updated_at в ServiceResponse (PR #56)

---

### Задача 2: Admin Panel — Полная (услуги + заказы + пользователи) ✅ ЗАВЕРШЕНА

**Описание:** Единая Admin Panel для управления всеми сущностями системы. Объединяет бывшие задачи 4, 5, 6.

**Стек:** TypeScript, React, react-admin, Vite
**Репозиторий:** `NMservices-Admin`

**Подзадачи:**

#### 2.1. Инициализация проекта ✅
- [x] 2.1.1. Создать проект (Vite + React + TypeScript)
- [x] 2.1.2. Установить react-admin и зависимости
- [x] 2.1.3. Настроить dataProvider для подключения к API
- [x] 2.1.4. Настроить authProvider (X-Admin-Key)

#### 2.2. Dashboard ✅
- [x] 2.2.1. Статистика: кол-во пользователей, заказов, услуг
- [x] 2.2.2. Заказы по статусам (pending/confirmed/in_progress/completed/cancelled)

#### 2.3. Услуги (services) ✅
- [x] 2.3.1. Список услуг (таблица с фильтрацией по дате и сортировкой)
- [x] 2.3.2. Просмотр услуги (детальная карточка)
- [x] 2.3.3. Создание услуги (форма)
- [x] 2.3.4. Редактирование услуги
- [x] 2.3.5. Деактивация услуги (soft delete, кнопка в списке)

#### 2.4. Заказы (orders) ✅
- [x] 2.4.1. Список заказов (фильтрация по статусу, дате; колонка Phone — ссылка на пользователя)
- [x] 2.4.2. Просмотр заказа (детали: пользователь, услуга, адрес, статус)
- [x] 2.4.3. Редактирование заказа (статус, адрес, время, сервис, notes)
- [x] 2.4.4. Создание заказа (ручное создание администратором)
- [x] 2.4.5. Автозаполнение суммы (Amount) из base_price выбранного сервиса (readOnly поле)
- [x] 2.4.6. Autocomplete поиск пользователя по ID/телефону в форме создания заказа

#### 2.5. Пользователи (users) ✅
- [x] 2.5.1. Список пользователей (таблица с фильтрацией по дате)
- [x] 2.5.2. Просмотр пользователя (профиль)
- [x] 2.5.3. Создание пользователя
- [x] 2.5.4. Раскрываемый список заказов пользователя (expand panel в таблице Users)

#### 2.6. Общие улучшения ✅
- [x] 2.6.1. Отображение версии приложения (из package.json) в AppBar

**Критерии завершения:**
- [x] Администратор может управлять услугами (CRUD + деактивация)
- [x] Администратор может управлять заказами (список, статус, детали, создание)
- [x] Администратор может просматривать пользователей с историей заказов
- [x] Dashboard показывает актуальную статистику

---

### Задача 3: Telegram-бот — Флоу создания заказа

**Описание:** Реализация пользовательского сценария заказа услуги

**Подзадачи:**
- [ ] 3.1. Интеграция с API услуг (получение списка активных услуг)
- [ ] 3.2. Экран выбора услуги (inline-кнопки или меню)
- [ ] 3.3. Ввод адреса (текстовое сообщение)
- [ ] 3.4. Подтверждение заказа (summary + кнопки Подтвердить/Отмена)
- [ ] 3.5. Отправка заказа в API
- [ ] 3.6. Сообщение об успешном создании заказа
- [ ] 3.7. Обработка ошибок (услуга не найдена, API недоступен)

**User flow:**
```
/start или кнопка "Заказать"
    → Список услуг (название + цена + длительность)
    → Выбор услуги
    → "Введите адрес"
    → Ввод адреса
    → "Ваш заказ: [услуга], [адрес], [цена]. Подтвердить?"
    → [Подтвердить] / [Отмена]
    → "Заказ #123 создан! Мы свяжемся с вами."
```

**Критерии завершения:**
- Пользователь может выбрать услугу из каталога
- Пользователь может указать адрес
- Заказ сохраняется в БД через API
- Пользователь получает подтверждение

---

### Задача 4: Telegram-бот — Уведомления о статусе заказа

**Описание:** Пользователь получает сообщение при изменении статуса заказа

**Подзадачи:**
- [ ] 4.1. Webhook/polling endpoint для получения событий об изменении статуса
- [ ] 4.2. Сервис отправки уведомлений по telegram_id
- [ ] 4.3. Шаблоны сообщений для разных статусов
- [ ] 4.4. Обработка случая, когда пользователь заблокировал бота

**Статусы заказа (примерные):**
- `pending` → "Заказ принят"
- `confirmed` → "Заказ подтверждён, мастер выезжает"
- `in_progress` → "Мастер на месте"
- `completed` → "Заказ выполнен. Спасибо!"
- `cancelled` → "Заказ отменён"

**Критерии завершения:**
- При смене статуса заказа пользователь получает сообщение в Telegram

---

### Задача 5: Интеграция и тестирование

**Описание:** Проверка работы всей системы целиком

**Подзадачи:**
- [ ] 5.1. E2E тест: создание заказа через бот → отображение в Admin Panel
- [ ] 5.2. E2E тест: смена статуса в Admin Panel → уведомление в Telegram
- [ ] 5.3. Проверка работы при ошибках (API down, невалидные данные)
- [ ] 5.4. Документирование API (OpenAPI/Swagger актуален)

**Критерии завершения:**
- Полный цикл заказа работает
- Система устойчива к ошибкам

---

## Зависимости между задачами

```
Задача 1 (Backend) ✅
    └── Задача 1b (Backend: расширение API) ✅
Задача 1 + 1b
    ├── Задача 2 (Admin Panel) ✅
    ├── Задача 3 (Бот: флоу заказа) — требует API услуг и заказов
    └── Задача 4 (Бот: уведомления) — требует механизм смены статуса (Admin Panel)

Задача 5 (Интеграция) — после всех остальных задач
```

**Порядок выполнения:**
1. **Задача 1** — Backend ✅ ЗАВЕРШЕНА
2. **Задача 1b** — Backend: расширение API для Admin Panel ✅ ЗАВЕРШЕНА
3. **Задача 2** — Admin Panel ✅ ЗАВЕРШЕНА
4. **Задача 3** — Telegram-бот: флоу заказа
5. **Задача 4** — Telegram-бот: уведомления о статусе
6. **Задача 5** — Финальная интеграция и тестирование

---

## Оценка объёма

| Задача | Компонент | Сложность | Статус |
|--------|-----------|-----------|--------|
| 1 | Backend (каталог, заказы) | Средняя | ✅ Завершена |
| 1b | Backend (расширение API) | Низкая | ✅ Завершена |
| 2 | Admin Panel (полная) | Средняя | ✅ Завершена |
| 3 | Telegram-бот (заказ) | Средняя | Следующая |
| 4 | Telegram-бот (уведомления) | Низкая | Ожидает |
| 5 | Интеграция | Низкая | Ожидает |

---

## Риски

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Изменение требований | Средняя | Гибкая архитектура, MVP подход |
| Проблемы с Telegram API | Низкая | Rate limiting, retry логика |
| Несовместимость версий | Низкая | Фиксация версий зависимостей |

---

## Связанные документы

- [MVP Services Table](./MVP_services_table.md) — детальное ТЗ для Задачи 1
- [TODO: Pydantic v2 ConfigDict](./TODO_pydantic_v2_config.md) — мелкий рефакторинг admin.py
- `docs/development/database-schema-mvp.md` — схема БД
- `docs/session-context-mvp-services.md` — контекст сессии lucid-beaver

---

## История изменений

| Дата | Версия | Описание |
|------|--------|----------|
| 2025-02-03 | 1.0 | Создание плана |
| 2026-02-10 | 2.0 | Задача 1 завершена. Реорганизация: Admin Panel (задачи 4+5+6) → Задача 2, Telegram-бот → Задачи 3-4 |
| 2026-02-15 | 3.0 | Задачи 1b, 2 завершены. Добавлена Задача 1b (расширение API). Admin Panel полностью реализована |
