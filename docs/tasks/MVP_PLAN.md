# Глобальный план работ: Этап MVP

## Обзор

**Цель MVP:** Реализовать минимальный функционал для приёма заказов на услуги массажа через Telegram-бот с управлением через Admin Panel.

**Компоненты системы:**
| Компонент | Технологии | Путь |
|-----------|------------|------|
| Backend (микросервисы) | Python, FastAPI, uvicorn | `C:\Users\zum\dev\python\NMservices` |
| Frontend (Telegram-бот) | Python, aiogram | `C:\Users\zum\dev\python\NMservices` |
| Frontend (Admin Panel) | TypeScript, React, react-admin, Vite | `C:\Users\zum\dev\js\NMservices-Admin` |
| База данных | PostgreSQL | nomus |

**Текущий статус:** Задачи 1, 1b, 2 завершены (2026-02-15)

---

## План работ

### Задача 1: Backend — Каталог услуг и расширение заказов ✅ ЗАВЕРШЕНА

**Описание:** Реализация функционала согласно `docs/tasks/MVP_services_table.md`

**Подзадачи:**
- [x] 1.1. Миграция: создание таблицы `services`
- [x] 1.2. Миграция: расширение таблицы `orders` (service_id, address_text, scheduled_at)
- [x] 1.3. SQLAlchemy модели (Service, обновление Order)
- [x] 1.4. Pydantic модели (ServiceResponse, ServiceCreateRequest, обновление OrderCreateRequest)
- [x] 1.5. API endpoints для услуг (CRUD)
- [x] 1.6. Обновление API endpoints для заказов
- [x] 1.7. Seed данные (базовые услуги)
- [x] 1.8. Обновление CLI утилиты (управление услугами)
- [x] 1.9. Тесты для новых endpoints (30/30 passed)
- [x] 1.10. Обновление документации

**Верификация (2026-02-10):**
- [x] Миграция БД на dm@id (3 миграции)
- [x] Структура БД через psql (7/7 проверок)
- [x] db_cli.py — услуги и заказы работают
- [x] pytest — 30/30 passed
- [x] API: GET /services, GET /services/1, POST /orders с service_id

**Критерии завершения:** см. `docs/tasks/MVP_services_table.md` → Критерии приёмки

---

### Задача 1b: Backend — Расширение API для Admin Panel ✅ ЗАВЕРШЕНА

**Описание:** Доработка backend API для полноценной поддержки Admin Panel (сортировка, фильтрация, поиск)

**Подзадачи:**
- [x] 1b.1. Перенос write-операций /services в /admin/services с X-Admin-Key авторизацией (PR #47)
- [x] 1b.2. Фильтрация по дате (date_from, date_to) для users, orders, services (PR #49)
- [x] 1b.3. Расширение сортировки (sort_by, order) для services: duration_minutes, created_at (PR #50)
- [x] 1b.4. Добавление sort_by полей для users и orders endpoints (PR #51)
- [x] 1b.5. Редактирование полей заказа: address_text, scheduled_at, service_id (PR #52)
- [x] 1b.6. Поиск пользователей по номеру телефона/ID (q параметр) (PR #53, #54)
- [x] 1b.7. Фильтрация заказов по user_id (PR #55)
- [x] 1b.8. Добавление created_at/updated_at в ServiceResponse (PR #56)

---

### Задача 2: Admin Panel — Полная (услуги + заказы + пользователи) ✅ ЗАВЕРШЕНА

**Описание:** Единая Admin Panel для управления всеми сущностями системы. Объединяет бывшие задачи 4, 5, 6.

**Стек:** TypeScript, React, react-admin, Vite
**Репозиторий:** `NMservices-Admin`

**Подзадачи:**

#### 2.1. Инициализация проекта ✅
- [x] 2.1.1. Создать проект (Vite + React + TypeScript)
- [x] 2.1.2. Установить react-admin и зависимости
- [x] 2.1.3. Настроить dataProvider для подключения к API
- [x] 2.1.4. Настроить authProvider (X-Admin-Key)

#### 2.2. Dashboard ✅
- [x] 2.2.1. Статистика: кол-во пользователей, заказов, услуг
- [x] 2.2.2. Заказы по статусам (pending/confirmed/in_progress/completed/cancelled)

#### 2.3. Услуги (services) ✅
- [x] 2.3.1. Список услуг (таблица с фильтрацией по дате и сортировкой)
- [x] 2.3.2. Просмотр услуги (детальная карточка)
- [x] 2.3.3. Создание услуги (форма)
- [x] 2.3.4. Редактирование услуги
- [x] 2.3.5. Деактивация услуги (soft delete, кнопка в списке)

#### 2.4. Заказы (orders) ✅
- [x] 2.4.1. Список заказов (фильтрация по статусу, дате; колонка Phone — ссылка на пользователя)
- [x] 2.4.2. Просмотр заказа (детали: пользователь, услуга, адрес, статус)
- [x] 2.4.3. Редактирование заказа (статус, адрес, время, сервис, notes)
- [x] 2.4.4. Создание заказа (ручное создание администратором)
- [x] 2.4.5. Автозаполнение суммы (Amount) из base_price выбранного сервиса (readOnly поле)
- [x] 2.4.6. Autocomplete поиск пользователя по ID/телефону в форме создания заказа

#### 2.5. Пользователи (users) ✅
- [x] 2.5.1. Список пользователей (таблица с фильтрацией по дате)
- [x] 2.5.2. Просмотр пользователя (профиль)
- [x] 2.5.3. Создание пользователя
- [x] 2.5.4. Раскрываемый список заказов пользователя (expand panel в таблице Users)

#### 2.6. Общие улучшения ✅
- [x] 2.6.1. Отображение версии приложения (из package.json) в AppBar

**Критерии завершения:**
- [x] Администратор может управлять услугами (CRUD + деактивация)
- [x] Администратор может управлять заказами (список, статус, детали, создание)
- [x] Администратор может просматривать пользователей с историей заказов
- [x] Dashboard показывает актуальную статистику

---

### Задача 3: Telegram-бот — Флоу создания заказа

**Описание:** Реализация полноценного сценария заказа услуги через Telegram-бот. Замена устаревшего flow тарифов на интеграцию с API каталога услуг NMservices (`GET /services`, `POST /orders`).

**Ключевые изменения относительно текущего кода:**
- Замена захардкоженных тарифов (`OrderService._TARIFFS`) на динамический каталог из API
- Добавление шага ввода текстового адреса
- Экран подтверждения заказа с summary
- Создание заказа через `POST /orders` с `service_id` и `address_text`
- Получение реального `order_id` из ответа API

**Подзадачи:**

#### Группа A: Рефакторинг + инфраструктура
- [ ] 3.1. `OrderService` — удалить `_TARIFFS`/`_TARIFF_CODES`, добавить `get_services()` → `GET /services`
- [ ] 3.2. `OrderService.create_order()` — принимать `service_id` + `address_text`, вызывать `POST /orders`
- [ ] 3.3. `OrderStates` — новые состояния FSM: `selecting_service`, `entering_address`, `confirming_order`
- [ ] 3.4. `PaymentServiceRemote` — адаптировать под новую схему API (`service_id`, `address_text`)

#### Группа B: Handlers + UI
- [ ] 3.5. Экран выбора услуги — inline-кнопки (название + цена + длительность)
- [ ] 3.6. Ввод адреса — текстовое сообщение
- [ ] 3.7. Подтверждение заказа — summary (услуга, цена, адрес) + [Подтвердить] / [Отмена]
- [ ] 3.8. Отправка заказа и сообщение об успешном создании (реальный `order_id`)

#### Группа C: Обработка ошибок + локализация
- [ ] 3.9. Обработка ошибок (API недоступен, услуга не найдена, ошибка создания заказа)
- [ ] 3.10. Локализация — новые ключи `messages.yaml` (ru, uz, en) + обновление модели `Messages`

**Примечание по адресу:**
> При регистрации сохраняются GPS-координаты (`latitude`, `longitude`), но `POST /orders` требует текстовый `address_text`. Для MVP пользователь вводит текстовый адрес вручную. В будущем: reverse geocoding для автозаполнения.

**User flow (обновлённый):**
```
Кнопка "Сделать заказ"
    → Проверка регистрации
    → GET /services → Список услуг (название + цена + длительность) [inline-кнопки]
    → Выбор услуги
    → "Введите адрес для выезда мастера"
    → Ввод адреса
    → "Ваш заказ: [услуга], [цена], [адрес]. Подтвердить?"
    → [Подтвердить] / [Отмена]
    → POST /orders (user_id, service_id, address_text)
    → "Заказ #123 создан! Мы свяжемся с вами."
```

**Критерии завершения:**
- Пользователь может просмотреть каталог активных услуг из API
- Пользователь может выбрать услугу из каталога
- Пользователь может указать текстовый адрес
- Пользователь видит summary заказа перед подтверждением
- Заказ создаётся через `POST /orders` с `service_id` и `address_text`
- Пользователь получает подтверждение с реальным `order_id`
- Ошибки API обрабатываются корректно

---

### Задача 4: Уведомления о статусе заказа (push + pull)

**Описание:** Двойная система уведомлений: push при смене статуса + pull при заходе в бот.

**Архитектура:**
- **Push (NMservices → Telegram API):** При смене статуса через `PATCH /admin/orders/{id}` NMservices отправляет сообщение пользователю напрямую через Telegram Bot API.
- **Pull (бот → NMservices):** При каждом взаимодействии пользователя с ботом `NotificationMiddleware` проверяет `GET /orders/pending-notifications` и показывает пропущенные уведомления.
- **Трекинг:** Поле `notified_status` в таблице `orders` отслеживает последний статус, о котором пользователь уведомлён.

**Подзадачи:**

#### NMservices:
- [x] 4.1. `OrderStatus` enum: `pending`, `confirmed`, `in_progress`, `completed`, `cancelled`
- [x] 4.2. Поле `notified_status` в Order + Alembic-миграция
- [x] 4.3. `TELEGRAM_BOT_TOKEN` в config.py
- [x] 4.4. `TelegramNotifier` сервис (httpx → Telegram Bot API `sendMessage`)
- [x] 4.5. Push в `PATCH /admin/orders/{id}` — при смене статуса отправить уведомление
- [x] 4.6. `GET /orders/pending-notifications?telegram_id=X` — непрочитанные уведомления
- [x] 4.7. `POST /orders/notifications/ack` — подтверждение доставки
- [x] 4.8. `notified_status = "pending"` при создании заказа через `POST /orders`

#### NoMus (бот):
- [x] 4.9. `OrderService.get_pending_notifications()` + `ack_notifications()`
- [x] 4.10. `NotificationMiddleware` — проверка при каждом взаимодействии
- [x] 4.11. Локализованные шаблоны уведомлений (ru, en, uz)

**Статусы заказа (`OrderStatus` enum):**
- `pending` → (начальный, пользователь знает из flow заказа)
- `confirmed` → "Заказ подтверждён. Мастер скоро свяжется."
- `in_progress` → "Мастер в пути."
- `completed` → "Заказ выполнен! Спасибо!"
- `cancelled` → "Заказ отменён."

**Flow уведомлений:**
```
Админ меняет статус → PATCH /admin/orders/{id}
    → Обнаружена смена статуса
    → TelegramNotifier.notify_order_status(telegram_id, ...)
    → Если доставлено: notified_status = status
    → Если НЕ доставлено: notified_status остаётся старым

Пользователь заходит в бот → NotificationMiddleware
    → GET /orders/pending-notifications?telegram_id=X
    → Показать пропущенные уведомления
    → POST /orders/notifications/ack → notified_status = status
```

**Критерии завершения:**
- При смене статуса заказа админом пользователь получает push-сообщение в Telegram
- Если push не доставлен — пользователь видит уведомление при следующем заходе в бот
- Уведомления локализованы на 3 языках (ru, en, uz)
- Содержат: номер заказа, название услуги, стоимость, новый статус

---

### Задача 5: Интеграция и тестирование

**Описание:** Проверка работы всей системы целиком

**Подзадачи:**
- [ ] 5.1. E2E тест: создание заказа через бот → отображение в Admin Panel
- [ ] 5.2. E2E тест: смена статуса в Admin Panel → уведомление в Telegram
- [ ] 5.3. Проверка работы при ошибках (API down, невалидные данные)
- [ ] 5.4. Документирование API (OpenAPI/Swagger актуален)

**Критерии завершения:**
- Полный цикл заказа работает
- Система устойчива к ошибкам

---

## Зависимости между задачами

```
Задача 1 (Backend) ✅
    └── Задача 1b (Backend: расширение API) ✅
Задача 1 + 1b
    ├── Задача 2 (Admin Panel) ✅
    ├── Задача 3 (Бот: флоу заказа) — требует API услуг и заказов
    └── Задача 4 (Бот: уведомления) — требует механизм смены статуса (Admin Panel)

Задача 5 (Интеграция) — после всех остальных задач
```

**Порядок выполнения:**
1. **Задача 1** — Backend ✅ ЗАВЕРШЕНА
2. **Задача 1b** — Backend: расширение API для Admin Panel ✅ ЗАВЕРШЕНА
3. **Задача 2** — Admin Panel ✅ ЗАВЕРШЕНА
4. **Задача 3** — Telegram-бот: флоу заказа
5. **Задача 4** — Telegram-бот: уведомления о статусе
6. **Задача 5** — Финальная интеграция и тестирование

---

## Оценка объёма

| Задача | Компонент | Сложность | Статус |
|--------|-----------|-----------|--------|
| 1 | Backend (каталог, заказы) | Средняя | ✅ Завершена |
| 1b | Backend (расширение API) | Низкая | ✅ Завершена |
| 2 | Admin Panel (полная) | Средняя | ✅ Завершена |
| 3 | Telegram-бот (заказ) | Средняя | Следующая |
| 4 | Telegram-бот (уведомления) | Низкая | Ожидает |
| 5 | Интеграция | Низкая | Ожидает |

---

## Риски

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Изменение требований | Средняя | Гибкая архитектура, MVP подход |
| Проблемы с Telegram API | Низкая | Rate limiting, retry логика |
| Несовместимость версий | Низкая | Фиксация версий зависимостей |

---

## Связанные документы

- [MVP Services Table](./MVP_services_table.md) — детальное ТЗ для Задачи 1
- [TODO: Pydantic v2 ConfigDict](./TODO_pydantic_v2_config.md) — мелкий рефакторинг admin.py
- `docs/development/database-schema-mvp.md` — схема БД
- `docs/session-context-mvp-services.md` — контекст сессии lucid-beaver

---

## История изменений

| Дата | Версия | Описание |
|------|--------|----------|
| 2025-02-03 | 1.0 | Создание плана |
| 2026-02-10 | 2.0 | Задача 1 завершена. Реорганизация: Admin Panel (задачи 4+5+6) → Задача 2, Telegram-бот → Задачи 3-4 |
| 2026-02-15 | 3.0 | Задачи 1b, 2 завершены. Добавлена Задача 1b (расширение API). Admin Panel полностью реализована |
