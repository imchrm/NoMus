# –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ flow –±–æ—Ç–∞ NoMus

–ù–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã (flow) –æ—Ç –∫–ª–∞—Å—Å–∞ –∫ –∫–ª–∞—Å—Å—É / –º–æ–¥—É–ª—é, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π —Ü–∏–∫–ª –æ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã `/start` –¥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞.
–í–∫–ª—é—á–µ–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ç–≤–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è, –∞ —Ç–∞–∫–∂–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π.

**–õ–µ–≥–µ–Ω–¥–∞:**
*   `[Presentation]` - –°–ª–æ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Handlers, States)
*   `[Application]` - –°–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Services)
*   `[Infrastructure]` - –°–ª–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (Repositories, External APIs)
*   `[Remote]` - –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –≤–Ω–µ—à–Ω–∏–º API (NMservices / PostgreSQL backend)
*   `->` - –ü–µ—Ä–µ–¥–∞—á–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–µ—Ä–µ—Ö–æ–¥ —Å–æ—Å—Ç–æ—è–Ω–∏—è)

---

## 1. –°—Ç–∞—Ä—Ç –∏ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (New!)

1.  **User** (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/start`)
2.  `->` **main.py** (Dispatcher –∑–∞–ø—É—Å–∫–∞–µ—Ç polling)
3.  `->` **Router** (–≤ `presentation.bot.handlers.common.py`) –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å
4.  `->` **common.cmd_start** (Handler)
    *   `->` `FSMContext.clear()` (–°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è)

    **–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (Development Mode):**
    *   –ï—Å–ª–∏ `ENV=development` –∏ `SKIP_REGISTRATION=True`:
        *   `->` –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–∫—Ç–∏–≤–Ω–æ–≥–æ (mock) –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
        *   `->` `FSMContext.update_data(is_registered=True)` (–£—Å—Ç–∞–Ω–æ–≤–∫–∞ FSM-—Ñ–ª–∞–≥–∞)
        *   `->` `Message.answer` (–°–æ–æ–±—â–µ–Ω–∏–µ –æ Dev Mode)
        *   `->` **–ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø. 3 (–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)**

    *   `->` **IUserRepository.get_user_by_telegram_id** (Infrastructure - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

    **–í–µ—Ç–≤–ª–µ–Ω–∏–µ:**

    *   **–°—Ü–µ–Ω–∞—Ä–∏–π –ê: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω** (–ù–∞–π–¥–µ–Ω –≤ –ë–î –∏ –µ—Å—Ç—å `phone_number`)
        *   `->` **IUserRepository.get_user_language** (–ó–∞–≥—Ä—É–∑–∫–∞ —è–∑—ã–∫–∞)
        *   `->` `FSMContext.update_data(is_registered=True)` (–£—Å—Ç–∞–Ω–æ–≤–∫–∞ FSM-—Ñ–ª–∞–≥–∞)
        *   `->` **common.get_main_kb** (–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: [üõí –°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑] [üìã –ú–æ–∏ –∑–∞–∫–∞–∑—ã] [‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏])
        *   `->` `Message.answer` (–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ "–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!", –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)
        *   `->` **–ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø. 3 (–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)**

    *   **–°—Ü–µ–Ω–∞—Ä–∏–π –ë: –ù–æ–≤—ã–π –∏–ª–∏ –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** (–ù–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
        *   `->` **IUserRepository.save_or_update_user** (–°–æ–∑–¥–∞–Ω–∏–µ "—á–µ—Ä–Ω–æ–≤–∏–∫–∞" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î —Å `username`, `full_name`, `language_code`, –Ω–æ –±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
        *   –ï—Å–ª–∏ —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ Telegram) —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–º–∏ (ru, uz, en):
            *   `->` `Message.answer` ("–Ø–∑—ã–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω: ...")
        *   `->` **common._send_language_selection** (–í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞)
        *   `->` `Message.answer` (–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫...", Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞)
        *   `->` **–ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø. 2 (–í—ã–±–æ—Ä —è–∑—ã–∫–∞)**

## 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞ –∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ

1.  **User** (–Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä "üá∑üá∫ –†—É—Å—Å–∫–∏–π")
2.  `->` **Router** (–≤ `presentation.bot.handlers.common.py`) –ª–æ–≤–∏—Ç `CallbackQuery` (`lang_ru`)
3.  `->` **common.process_lang_select** (Handler)
    *   `->` **IUserRepository.update_user_language** (–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —è–∑—ã–∫–∞ –≤ –ë–î)
    *   `->` **Settings** (–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞)
    *   `->` `CallbackQuery.message.edit_text` (–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–º–µ–Ω—ã —è–∑—ã–∫–∞)
    *   `->` **common.get_agreement_kb** (–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: "–û—Ç–∫—Ä—ã—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ", "–ü—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è")
    *   `->` `Message.answer` (–û—Ç–ø—Ä–∞–≤–∫–∞: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–º–∏—Ç–µ —É—Å–ª–æ–≤–∏—è...", Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞)
4.  `->` **User** (–≤–∏–¥–∏—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è)

   > **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫–Ω–æ–ø–∫—É "–ü—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è", –æ–Ω –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é. –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–≤ –ë–î).

## 3. –ü—Ä–∏–Ω—è—Ç–∏–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –∏ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

1.  **User** (–Ω–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è")
2.  `->` **Router** (–≤ `presentation.bot.handlers.common.py`) –ª–æ–≤–∏—Ç `CallbackQuery` (`agree_terms_ru`)
3.  `->` **common.process_agreement** (Handler)
    *   `->` `CallbackQuery.message.delete` (–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ–º)
    *   `->` **common.get_main_kb** (–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: [–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è] [‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏])
    *   `->` `Message.answer` (–û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é)
4.  `->` **User** (–≤–∏–¥–∏—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)

> **–ì–ª–∞–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (reply keyboard)** –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
> - –ù–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: `[–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è]` `[‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏]`
> - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: `[üõí –°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑]` `[üìã –ú–æ–∏ –∑–∞–∫–∞–∑—ã]` `[‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏]`

## 4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

1.  **User** (–Ω–∞–∂–∏–º–∞–µ—Ç "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è")
2.  `->` **Router** (—Ñ–∏–ª—å—Ç—Ä `EmojiPrefixEquals("registration_button")`) –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å
3.  `->` **registration.start_registration** (Handler –≤ `presentation.bot.handlers.registration.py`)
    *   `->` `Message.answer` (–ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ `request_location=True`)
    *   `->` `FSMContext.set_state(RegistrationStates.waiting_for_location)`
3.  `->` **User** (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–∫–∞—Ü–∏—é)

4.  **Router** (–ª–æ–≤–∏—Ç `F.location` –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `waiting_for_location`)
5.  `->` **registration.process_location** (Handler)
    *   `->` `FSMContext.update_data` (–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç latitude, longitude)
    *   `->` `Message.answer` (–ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ç–∞–∫—Ç–∞, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ `request_contact=True`)
    *   `->` `FSMContext.set_state(RegistrationStates.waiting_for_phone)`
6.  `->` **User** (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç)

7.  **Router** (–ª–æ–≤–∏—Ç `F.contact` –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `waiting_for_phone`)
8.  `->` **registration.process_phone** (Handler)
    *   `->` `FSMContext.update_data` (–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
    *   `->` **AuthService.send_verification_code** (Application Service)
        *   `->` **SmsServiceRemote.send_sms** (Infrastructure)
            *   `->` **POST /users/register** (Remote API) ‚Äî –ü–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    *   `->` `Message.answer` ("–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω...", —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)
    *   `->` `FSMContext.set_state(RegistrationStates.waiting_for_sms_code)`
9.  `->` **User** (–≤–≤–æ–¥–∏—Ç –∫–æ–¥ "1234")

10. **Router** (–ª–æ–≤–∏—Ç —Ç–µ–∫—Å—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `waiting_for_sms_code`)
11. `->` **registration.process_code** (Handler)
    *   `->` –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–¥–∞ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è "1234"
    *   `->` **AuthService.register_user** (Application Service)
        *   `->` **SmsServiceRemote.send_sms** (Infrastructure)
            *   `->` **POST /users/register** (Remote API) ‚Äî –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤/–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
            *   `->` –ü–æ–ª—É—á–µ–Ω–∏–µ `user_id` –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (server_id)
        *   `->` –í–æ–∑–≤—Ä–∞—Ç `server_user_id`
    *   `->` –°–æ–∑–¥–∞–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏ **User** (—Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö: `phone`, `geo`, `server_user_id`)
    *   `->` **IUserRepository.save_or_update_user** (Infrastructure / RemoteStorage)
        *   `->` –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à (MemoryStorage)
    *   `->` **RemoteStorage.flush** (Infrastructure)
        *   `->` –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π ("dirty" records) —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º (—á–µ—Ä–µ–∑ `RemoteApiClient`)
    *   `->` `Message.answer` ("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    *   `->` `FSMContext.update_data(is_registered=True)` (–£—Å—Ç–∞–Ω–æ–≤–∫–∞ FSM-—Ñ–ª–∞–≥–∞)
    *   **–ü–µ—Ä–µ—Ö–æ–¥ –∫ –∑–∞–∫–∞–∑—É:**
        *   `->` **ordering._start_service_selection** (–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
            *   `->` **OrderService.get_services** (Application Service ‚Üí `GET /services`)
            *   `->` `FSMContext.update_data` (–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—Å–ª—É–≥)
            *   `->` `Message.answer` ("–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:", Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å —É—Å–ª—É–≥–∞–º–∏)
            *   `->` `FSMContext.set_state(OrderStates.selecting_service)`

## 5. –í—ã–±–æ—Ä —É—Å–ª—É–≥–∏

1.  **User** (–Ω–∞–∂–∏–º–∞–µ—Ç "üõí –°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑")
2.  `->` **Router** (—Ñ–∏–ª—å—Ç—Ä `EmojiPrefixEquals("start_ordering_button")`) –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å
3.  `->` **ordering.start_ordering** (Handler) ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –∑–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥
4.  **User** (–Ω–∞–∂–∏–º–∞–µ—Ç inline-–∫–Ω–æ–ø–∫—É —É—Å–ª—É–≥–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂ ‚Äî 150 000 —Å—É–º (60 min)")
2.  `->` **Router** (–ª–æ–≤–∏—Ç `CallbackQuery` `svc_{id}` –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `selecting_service`)
3.  `->` **ordering.process_service_selection** (Handler –≤ `presentation.bot.handlers.ordering.py`)
    *   `->` –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —É—Å–ª—É–≥–∏ (–ø–æ ID –∏–∑ callback_data)
    *   `->` `FSMContext.update_data` (–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —É—Å–ª—É–≥–∏ –∏ service_id)
    *   `->` `CallbackQuery.message.edit_text` (–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞, —É–±–∏—Ä–∞–µ—Ç inline-–∫–Ω–æ–ø–∫–∏)
    *   `->` `Message.answer` ("–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –≤—ã–µ–∑–¥–∞ –º–∞—Å—Ç–µ—Ä–∞...")
    *   `->` `FSMContext.set_state(OrderStates.entering_address)`
4.  `->` **User** (–≤–∏–¥–∏—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–∞)

## 6. –í–≤–æ–¥ –∞–¥—Ä–µ—Å–∞

1.  **User** (–≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä "—É–ª. –ù–∞–≤–æ–∏ 25, –∫–≤. 12")
2.  `->` **Router** (–ª–æ–≤–∏—Ç —Ç–µ–∫—Å—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `entering_address`)
3.  `->` **ordering.process_address** (Handler)
    *   `->` –í–∞–ª–∏–¥–∞—Ü–∏—è (–Ω–µ–ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç)
    *   `->` `FSMContext.update_data` (–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞)
    *   `->` –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ summary (—É—Å–ª—É–≥–∞, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Ü–µ–Ω–∞, –∞–¥—Ä–µ—Å)
    *   `->` `Message.answer` (Summary + Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞: [–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å] [–û—Ç–º–µ–Ω–∏—Ç—å])
    *   `->` `FSMContext.set_state(OrderStates.confirming_order)`
4.  `->` **User** (–≤–∏–¥–∏—Ç summary –∑–∞–∫–∞–∑–∞)

## 7. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞

1.  **User** (–Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å")
2.  `->` **Router** (–ª–æ–≤–∏—Ç `CallbackQuery` "order_confirm" –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `confirming_order`)
3.  `->` **ordering.process_order_confirm** (Handler)
    *   `->` `CallbackQuery.message.edit_text` ("–°–æ–∑–¥–∞—ë–º –≤–∞—à –∑–∞–∫–∞–∑...")
    *   `->` **OrderService.get_server_user_id** (–ü–æ–ª—É—á–µ–Ω–∏–µ server_user_id –∏–∑ –∫–µ—à–∞)
    *   `->` **OrderService.create_order** (Application Service)
        *   `->` **RemoteApiClient.post("/orders")** ‚Äî `POST /orders` —Å `{user_id, service_id, address_text}`
        *   `->` –ü–æ–ª—É—á–µ–Ω–∏–µ `order_id` –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
    *   `->` –ï—Å–ª–∏ —É—Å–ø–µ—Ö:
        *   `->` `CallbackQuery.message.edit_text` ("–ó–∞–∫–∞–∑ #{order_id} —Å–æ–∑–¥–∞–Ω!")
        *   `->` `Message.answer` (–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: `get_main_kb(is_registered=True)`)
    *   `->` –ï—Å–ª–∏ –æ—à–∏–±–∫–∞:
        *   `->` `CallbackQuery.message.edit_text` ("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞")
    *   `->` `FSMContext.clear()` (–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è)

    **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞**
    *   **User** (–Ω–∞–∂–∏–º–∞–µ—Ç "–û—Ç–º–µ–Ω–∏—Ç—å")
    *   `->` **ordering.process_order_cancel** (Handler)
        *   `->` `CallbackQuery.message.edit_text` ("–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—ë–Ω")
        *   `->` `FSMContext.clear()`

---

## 8. –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (¬´–ú–æ–∏ –∑–∞–∫–∞–∑—ã¬ª)

1.  **User** (–Ω–∞–∂–∏–º–∞–µ—Ç "üìã –ú–æ–∏ –∑–∞–∫–∞–∑—ã")
2.  `->` **Router** (—Ñ–∏–ª—å—Ç—Ä `EmojiPrefixEquals("my_orders_button")`) –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å
3.  `->` **my_order.show_my_orders** (Handler –≤ `presentation.bot.handlers.my_order.py`)
    *   `->` **OrderService.get_active_orders** (Application Service)
        *   `->` **RemoteApiClient.get("/orders/active")** ‚Äî `GET /orders/active?telegram_id=X`
        *   `->` –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{orders: [...]}` (—Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ `pending`, `confirmed`, `in_progress`)
    *   **–ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç:**
        *   `->` `Message.answer` ("–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.")
    *   **–ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–∫–∞–∑—ã:**
        *   `->` –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞ (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞: –Ω–æ–º–µ—Ä, —É—Å–ª—É–≥–∞, —Å—É–º–º–∞, –∞–¥—Ä–µ—Å, —Å—Ç–∞—Ç—É—Å)
        *   `->` –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ —á–µ—Ä–µ–∑ `_STATUS_KEY_MAP` ‚Üí `lexicon.status_*`
        *   `->` `Message.answer` (–ó–∞–≥–æ–ª–æ–≤–æ–∫ + —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤)

> **–ö–Ω–æ–ø–∫–∞ ¬´üìã –ú–æ–∏ –∑–∞–∫–∞–∑—ã¬ª –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞** –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞–ª–∏—á–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.

---

## 9. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞

### Push (NMservices ‚Üí Telegram API)

1.  **Admin** (–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ `PATCH /admin/orders/{id}`)
2.  `->` **admin/orders.update_order** ‚Üí –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞
3.  `->` **_notify_status_change** (Helper)
    *   `->` –ó–∞–≥—Ä—É–∑–∫–∞ user (telegram_id, language_code) –∏ service (name)
    *   `->` **TelegramNotifier.notify_order_status** (httpx ‚Üí Telegram Bot API)
    *   `->` –ï—Å–ª–∏ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: `order.notified_status = order.status` ‚Üí commit
    *   `->` –ï—Å–ª–∏ –ù–ï –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: notified_status –æ—Å—Ç–∞—ë—Ç—Å—è —Å—Ç–∞—Ä—ã–º

### Pull (–±–æ—Ç ‚Üí NMservices –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

1.  **User** (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
2.  `->` **NotificationMiddleware** (runs on every message/callback)
    *   `->` **OrderService.get_pending_notifications** (Application Service)
        *   `->` `GET /orders/pending-notifications?telegram_id=X`
        *   `->` NMservices: `SELECT ... FROM orders WHERE notified_status != status`
    *   `->` –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: `Bot.send_message` (–ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω)
    *   `->` **OrderService.ack_notifications** (Application Service)
        *   `->` `POST /orders/notifications/ack` ‚Üí `notified_status = status`
3.  `->` –î–∞–ª–µ–µ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–º flow

---

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ê. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–∫–∞–∑–∞ –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

–°–∏—Ç—É–∞—Ü–∏—è: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ, –≤–∏–¥–∏—Ç –º–µ–Ω—é, –Ω–æ —Å—Ä–∞–∑—É –Ω–∞–∂–∞–ª "üõí –°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑", –Ω–µ –ø—Ä–æ–π–¥—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.

1.  **User** (–Ω–∞–∂–∏–º–∞–µ—Ç "üõí –°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑")
2.  `->` **ordering.start_ordering** (Handler)
    *   `->` **AuthService.is_user_registered** (Application Service) -> –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`
    *   `->` `Message.answer` (–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: "–î–ª—è –∑–∞–∫–∞–∑–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è")
3.  `->` **User** (–æ—Å—Ç–∞–µ—Ç—Å—è –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é, –¥–æ–ª–∂–µ–Ω –Ω–∞–∂–∞—Ç—å "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è")

### –ë. –û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

–°–∏—Ç—É–∞—Ü–∏—è: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ SMS.

1.  **User** (–≤–≤–æ–¥–∏—Ç "0000" –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `waiting_for_sms_code`)
2.  `->` **registration.process_code** (Handler)
    *   `->` –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ ("0000" != "1234")
    *   `->` `Message.answer` ("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥")
3.  `->` **User** (–æ—Å—Ç–∞–µ—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `waiting_for_sms_code`, –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –≤–≤–æ–¥)

### –í. –û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è

–°–∏—Ç—É–∞—Ü–∏—è: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `/cancel` –∏–ª–∏ –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã (–µ—Å–ª–∏ –æ–Ω–∞ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–∞) –≤ –ª—é–±–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.

1.  **User** (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/cancel`)
2.  `->` **common.cmd_cancel** (Handler –≤ `presentation.bot.handlers.common.py`)
    *   `->` **_get_is_registered** (–ü—Ä–æ–≤–µ—Ä–∫–∞ FSM-—Ñ–ª–∞–≥–∞ `is_registered`, fallback ‚Üí `AuthService.is_user_registered`)
    *   `->` `FSMContext.clear()` (–°–±—Ä–æ—Å –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π)
    *   `->` `FSMContext.update_data(is_registered=True)` (–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω)
    *   `->` **common.get_main_kb** (–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å —É—á—ë—Ç–æ–º `is_registered`)
    *   `->` `Message.answer` ("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ", –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –º–µ–Ω—é)
3.  `->` **User** (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)

### –ì. –°–º–µ–Ω–∞ —è–∑—ã–∫–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)

–°–∏—Ç—É–∞—Ü–∏—è: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç —è–∑—ã–∫ —á–µ—Ä–µ–∑ ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –Ø–∑—ã–∫.

1.  **User** (–Ω–∞–∂–∏–º–∞–µ—Ç "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "–Ø–∑—ã–∫" ‚Üí –≤—ã–±–∏—Ä–∞–µ—Ç –Ω–æ–≤—ã–π —è–∑—ã–∫)
2.  `->` **common.process_lang_select** (Handler)
    *   `->` **IUserRepository.update_user_language** (–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —è–∑—ã–∫–∞)
    *   `->` `CallbackQuery.message.edit_text` (–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–º–µ–Ω—ã)
    *   `->` –ß—Ç–µ–Ω–∏–µ `is_registered` –∏–∑ FSMContext (fallback ‚Üí `AuthService.is_user_registered`)
    *   `->` `FSMContext.clear()` + –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ `is_registered`
    *   `->` `Message.answer` (–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ + **–æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞** –Ω–∞ –Ω–æ–≤–æ–º —è–∑—ã–∫–µ)
    *   `->` **settings._show_settings_menu** (–í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫)
3.  `->` **User** (–≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞ –Ω–æ–≤–æ–º —è–∑—ã–∫–µ)
