# –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ flow –±–æ—Ç–∞ NoMus

–ù–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã (flow) –æ—Ç –∫–ª–∞—Å—Å–∞ –∫ –∫–ª–∞—Å—Å—É / –º–æ–¥—É–ª—é, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π —Ü–∏–∫–ª –æ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã `/start` –¥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞.
–í–∫–ª—é—á–µ–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ç–≤–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è, –∞ —Ç–∞–∫–∂–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π.

**–õ–µ–≥–µ–Ω–¥–∞:**
*   `[Presentation]` - –°–ª–æ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Handlers, States)
*   `[Application]` - –°–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Services)
*   `[Infrastructure]` - –°–ª–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (Repositories, External APIs)
*   `->` - –ü–µ—Ä–µ–¥–∞—á–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–µ—Ä–µ—Ö–æ–¥ —Å–æ—Å—Ç–æ—è–Ω–∏—è)

---

## 1. –°—Ç–∞—Ä—Ç –∏ –í—ã–±–æ—Ä —è–∑—ã–∫–∞

1.  **User** (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/start`)
2.  `->` **main.py** (Dispatcher –∑–∞–ø—É—Å–∫–∞–µ—Ç polling)
3.  `->` **Router** (–≤ `presentation.bot.handlers.common.py`) –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å
4.  `->` **common.cmd_start** (Handler)
    *   `->` `FSMContext.clear()` (–°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è)
    *   `->` **language._send_language_selection** (–í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞)
    *   `->` `Message.answer` (–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Please select your language...", Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞)
5.  `->` **User** (–≤–∏–¥–∏—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞)

## 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞ –∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ

1.  **User** (–Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä "üá∑üá∫ –†—É—Å—Å–∫–∏–π")
2.  `->` **Router** (–≤ `presentation.bot.handlers.language.py`) –ª–æ–≤–∏—Ç `CallbackQuery` (`lang_ru`)
3.  `->` **language.process_lang_select** (Handler)
    *   `->` **MemoryStorage.update_user_language** (Infrastructure / Repo - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —è–∑—ã–∫–∞)
    *   `->` **Settings** (–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞)
    *   `->` `CallbackQuery.message.edit_text` (–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–º–µ–Ω—ã —è–∑—ã–∫–∞)
    *   `->` **language.get_agreement_kb** (–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: "–û—Ç–∫—Ä—ã—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ", "–ü—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è")
    *   `->` `Message.answer` (–û—Ç–ø—Ä–∞–≤–∫–∞: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–º–∏—Ç–µ —É—Å–ª–æ–≤–∏—è...", Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞)
4.  `->` **User** (–≤–∏–¥–∏—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è)

   > **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫–Ω–æ–ø–∫—É "–ü—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è", –æ–Ω –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é. –õ—é–±–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–∏–±–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω, –ª–∏–±–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `/start` –Ω–∞—á–Ω–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–Ω–æ–≤–æ).

## 3. –ü—Ä–∏–Ω—è—Ç–∏–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –∏ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

1.  **User** (–Ω–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è")
2.  `->` **Router** (–≤ `presentation.bot.handlers.language.py`) –ª–æ–≤–∏—Ç `CallbackQuery` (`agree_terms_ru`)
3.  `->` **language.process_agreement** (Handler)
    *   `->` `CallbackQuery.message.delete` (–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ–º)
    *   `->` **common.get_start_kb** (–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", "–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑")
    *   `->` `Message.answer` (–û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é)
4.  `->` **User** (–≤–∏–¥–∏—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)

## 4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

1.  **User** (–Ω–∞–∂–∏–º–∞–µ—Ç "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è")
2.  `->` **registration.start_registration** (Handler –≤ `presentation.bot.handlers.registration.py`)
    *   `->` `Message.answer` (–ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ `request_location=True`)
    *   `->` `FSMContext.set_state(RegistrationStates.waiting_for_location)`
3.  `->` **User** (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–∫–∞—Ü–∏—é)

4.  **Router** (–ª–æ–≤–∏—Ç `F.location` –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `waiting_for_location`)
5.  `->` **registration.process_location** (Handler)
    *   `->` `FSMContext.update_data` (–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç latitude, longitude)
    *   `->` `Message.answer` (–ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ç–∞–∫—Ç–∞, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ `request_contact=True`)
    *   `->` `FSMContext.set_state(RegistrationStates.waiting_for_phone)`
6.  `->` **User** (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç)

7.  **Router** (–ª–æ–≤–∏—Ç `F.contact` –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `waiting_for_phone`)
8.  `->` **registration.process_phone** (Handler)
    *   `->` `FSMContext.update_data` (–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
    *   `->` **AuthService.send_verification_code** (Application Service)
        *   `->` **SmsServiceStub.send** (Infrastructure)
    *   `->` `Message.answer` ("–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω...", —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)
    *   `->` `FSMContext.set_state(RegistrationStates.waiting_for_sms_code)`
9.  `->` **User** (–≤–≤–æ–¥–∏—Ç –∫–æ–¥ "1234")

10. **Router** (–ª–æ–≤–∏—Ç —Ç–µ–∫—Å—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `waiting_for_sms_code`)
11. `->` **registration.process_code** (Handler)
    *   `->` –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–¥–∞ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è "1234"
    *   `->` –°–æ–∑–¥–∞–Ω–∏–µ/–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏ **User** (–≤–∫–ª—é—á–∞—è geo –∏ phone)
    *   `->` **AuthService.user_repo.save_or_update_user** (Infrastructure / Repo)
    *   `->` `Message.answer` ("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    *   **–ü–µ—Ä–µ—Ö–æ–¥ –∫ –∑–∞–∫–∞–∑—É:**
        *   `->` **MemoryStorage.get_user_language** (–ü–æ–ª—É—á–µ–Ω–∏–µ —è–∑—ã–∫–∞)
        *   `->` **ordering._start_tariff_selection** (–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
            *   `->` **OrderService.get_tariffs** (Application Service)
            *   `->` `FSMContext.update_data` (–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤)
            *   `->` `Message.answer` (–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ç–∞—Ä–∏—Ñ–æ–≤)
            *   `->` `FSMContext.set_state(OrderStates.selecting_tariff)`

## 5. –í—ã–±–æ—Ä –∑–∞–∫–∞–∑–∞ –∏ –û–ø–ª–∞—Ç–∞

1.  **User** (–≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ, –Ω–∞–ø—Ä–∏–º–µ—Ä "Start")
2.  `->` **Router** (–ª–æ–≤–∏—Ç —Ç–µ–∫—Å—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `selecting_tariff`)
3.  `->` **ordering.process_tariff** (Handler –≤ `presentation.bot.handlers.ordering.py`)
    *   `->` –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∞—Ä–∏—Ñ–∞
    *   `->` `FSMContext.update_data` (–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ –∏ —Å—É–º–º—ã)
    *   `->` –°–æ–∑–¥–∞–Ω–∏–µ `InlineKeyboardMarkup` (–ö–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏—Ç—å X —Å—É–º")
    *   `->` `Message.answer` (–ò–Ω–≤–æ–π—Å/–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ)
    *   `->` `FSMContext.set_state(OrderStates.waiting_for_payment)`
4.  `->` **User** (–Ω–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å")

5.  **Router** (–ª–æ–≤–∏—Ç `CallbackQuery` "pay" –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `waiting_for_payment`)
6.  `->` **ordering.process_payment** (Handler)
    *   `->` `CallbackQuery.message.edit_text` ("–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...")
    *   `->` **OrderService.create_order** (Application Service)
        *   `->` **PaymentServiceStub.process_payment** (Simulation)
        *   `->` –ï—Å–ª–∏ —É—Å–ø–µ—Ö:
            *   `->` **MemoryStorage.save_order** (Repo)
            *   `->` –í–æ–∑–≤—Ä–∞—Ç `True`
    *   `->` `CallbackQuery.message.delete()`
    *   `->` `CallbackQuery.message.answer` ("–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω –∏ —Å–æ–∑–¥–∞–Ω!", —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)
    *   `->` `CallbackQuery.message.answer` (–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞)
    *   `->` `FSMContext.clear()` (–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è)

---

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ê. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–∫–∞–∑–∞ –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

–°–∏—Ç—É–∞—Ü–∏—è: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ, –≤–∏–¥–∏—Ç –º–µ–Ω—é, –Ω–æ —Å—Ä–∞–∑—É –Ω–∞–∂–∞–ª "–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑", –Ω–µ –ø—Ä–æ–π–¥—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.

1.  **User** (–Ω–∞–∂–∏–º–∞–µ—Ç "–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑")
2.  `->` **ordering.start_ordering** (Handler)
    *   `->` **AuthService.is_user_registered** (Application Service) -> –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`
    *   `->` `Message.answer` (–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: "–î–ª—è –∑–∞–∫–∞–∑–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è")
3.  `->` **User** (–æ—Å—Ç–∞–µ—Ç—Å—è –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é, –¥–æ–ª–∂–µ–Ω –Ω–∞–∂–∞—Ç—å "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è")

### –ë. –û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

–°–∏—Ç—É–∞—Ü–∏—è: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ SMS.

1.  **User** (–≤–≤–æ–¥–∏—Ç "0000" –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `waiting_for_sms_code`)
2.  `->` **registration.process_code** (Handler)
    *   `->` –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ ("0000" != "1234")
    *   `->` `Message.answer` ("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥")
3.  `->` **User** (–æ—Å—Ç–∞–µ—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `waiting_for_sms_code`, –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –≤–≤–æ–¥)

### –í. –û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è

–°–∏—Ç—É–∞—Ü–∏—è: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `/cancel` –∏–ª–∏ –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã (–µ—Å–ª–∏ –æ–Ω–∞ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–∞) –≤ –ª—é–±–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.

1.  **User** (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/cancel`)
2.  `->` **common.cmd_cancel** (Handler –≤ `presentation.bot.handlers.common.py`)
    *   `->` `FSMContext.clear()` (–°–±—Ä–æ—Å –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π)
    *   `->` **common.get_start_kb** (–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)
    *   `->` `Message.answer` ("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ", –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –º–µ–Ω—é)
3.  `->` **User** (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)
